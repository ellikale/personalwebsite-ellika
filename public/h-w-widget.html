<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>How to Grovel (The Right Way) ‚Ä¢ H-W Widget</title>
    <style media="screen">
      :root {
        --sky: #8faec0;
        --deep-sky: #698da5;
        --emerald: #1d8a66;
        --pine: #0f4333;
        --frost: rgba(255, 255, 255, 0.9);
        --frost-muted: rgba(255, 255, 255, 0.6);
        --panel: rgba(9, 39, 55, 0.4);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: var(--frost);
        background: linear-gradient(135deg, var(--sky) 0%, var(--deep-sky) 45%, #0c2d46 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        scroll-behavior: smooth;
      }

      main {
        width: min(960px, 92vw);
        padding: 96px 0 120px;
      }

      header {
        text-align: center;
        margin-bottom: 48px;
      }

      header h1 {
        font-size: clamp(2.8rem, 6vw, 3.6rem);
        font-weight: 700;
        letter-spacing: 0.02em;
        margin: 0 0 16px 0;
      }

      header .subtitle {
        font-size: clamp(1.2rem, 3vw, 1.4rem);
        color: var(--frost-muted);
        font-style: italic;
        margin: 0 0 32px 0;
        line-height: 1.6;
      }

      .back-link {
        display: inline-block;
        color: var(--frost);
        text-decoration: none;
        font-weight: 600;
        padding: 10px 18px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.08);
        transition: transform 180ms ease, background 180ms ease, border-color 180ms ease;
        margin-bottom: 40px;
      }

      .back-link:hover,
      .back-link:focus {
        border-color: rgba(255, 255, 255, 0.6);
        background: rgba(255, 255, 255, 0.18);
        transform: translateY(-2px);
      }

      section {
        background: var(--panel);
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 28px;
        padding: clamp(32px, 6vw, 48px);
        backdrop-filter: blur(12px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.28);
        margin-bottom: 36px;
      }

      section:last-of-type {
        margin-bottom: 0;
      }

      h2 {
        font-size: clamp(2rem, 4.5vw, 2.4rem);
        margin: 0 0 20px 0;
        letter-spacing: 0.03em;
        color: var(--frost);
      }

      h3 {
        font-size: clamp(1.4rem, 3vw, 1.7rem);
        margin: 32px 0 16px 0;
        letter-spacing: 0.02em;
        color: var(--frost);
      }

      h3:first-of-type {
        margin-top: 0;
      }

      p {
        margin: 0 0 20px 0;
        line-height: 1.8;
        color: var(--frost-muted);
        font-size: clamp(1rem, 2.6vw, 1.12rem);
      }

      p:last-child {
        margin-bottom: 0;
      }

      .step-list {
        list-style: none;
        padding: 0;
        margin: 24px 0;
        display: flex;
        flex-direction: column;
        gap: 32px;
      }

      .step-list li {
        padding-left: 0;
      }

      .step-list li strong {
        display: block;
        font-size: clamp(1.2rem, 3vw, 1.4rem);
        color: var(--frost);
        margin-bottom: 12px;
        letter-spacing: 0.02em;
      }

      .template {
        background: rgba(0, 0, 0, 0.2);
        border-left: 4px solid var(--emerald);
        padding: 24px;
        border-radius: 12px;
        margin: 24px 0;
      }

      .template h3 {
        margin-top: 0;
        margin-bottom: 16px;
      }

      .template .subject {
        font-weight: 600;
        color: var(--frost);
        margin-bottom: 8px;
      }

      .template .body {
        white-space: pre-line;
        font-family: 'Courier New', monospace;
        font-size: 0.95rem;
        line-height: 1.7;
        color: var(--frost-muted);
      }

      .bonus-tips {
        list-style: none;
        padding: 0;
        margin: 24px 0;
      }

      .bonus-tips li {
        padding-left: 24px;
        margin-bottom: 16px;
        line-height: 1.7;
        color: var(--frost-muted);
        position: relative;
      }

      .bonus-tips li:before {
        content: "üí°";
        position: absolute;
        left: 0;
      }

      .bonus-tips li:last-child {
        margin-bottom: 0;
      }

      .warning {
        background: rgba(255, 200, 87, 0.15);
        border: 2px solid rgba(255, 200, 87, 0.4);
        border-left: 4px solid rgba(255, 200, 87, 0.8);
        padding: 24px;
        border-radius: 12px;
        margin: 0;
      }

      .warning h3 {
        margin-top: 0;
        margin-bottom: 16px;
        color: rgba(255, 220, 150, 1);
      }

      .warning p {
        color: rgba(255, 240, 200, 0.9);
        margin-bottom: 12px;
      }

      .warning .response {
        background: rgba(0, 0, 0, 0.2);
        padding: 16px;
        border-radius: 8px;
        margin-top: 16px;
        font-style: italic;
        color: rgba(255, 240, 200, 0.95);
      }

      .side-by-side-container {
        display: flex;
        gap: 24px;
        margin-bottom: 36px;
        align-items: flex-start;
      }

      .warning-section {
        flex: 0 0 320px;
        background: var(--panel);
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 28px;
        padding: clamp(32px, 6vw, 48px);
        backdrop-filter: blur(12px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.28);
        position: sticky;
        top: 20px;
      }

      .chat-section {
        display: block !important;
        flex: 1;
        background: var(--panel);
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 28px;
        padding: clamp(32px, 6vw, 48px);
        backdrop-filter: blur(12px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.28);
        visibility: visible !important;
        opacity: 1 !important;
        min-height: 200px;
        position: relative;
      }

      .chat-container {
        background: rgba(0, 0, 0, 0.25);
        border-radius: 16px;
        padding: 24px;
        margin-top: 24px;
        max-height: 500px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .chat-placeholder {
        text-align: center;
        color: var(--frost-muted);
        font-style: italic;
        padding: 32px 12px;
      }

      .chat-message {
        display: flex;
        flex-direction: column;
        gap: 8px;
        animation: fadeIn 0.3s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes loadingBounce {
        0%,
        80%,
        100% {
          transform: scale(0.8);
          opacity: 0.5;
        }
        40% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .message-header {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--frost);
      }

      .message-header.teacher {
        color: rgba(255, 220, 150, 1);
      }

      .message-header .icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        background: rgba(255, 255, 255, 0.1);
      }

      .message-header.teacher .icon {
        background: rgba(255, 200, 87, 0.3);
      }

      .message-content {
        background: rgba(0, 0, 0, 0.3);
        padding: 16px 20px;
        border-radius: 12px;
        line-height: 1.6;
        color: var(--frost-muted);
        white-space: pre-wrap;
        margin-left: 44px;
      }

      .message-content.teacher {
        background: rgba(255, 200, 87, 0.15);
        border-left: 3px solid rgba(255, 200, 87, 0.5);
        color: rgba(255, 240, 200, 0.9);
      }

      .message-content.error {
        border-left: 3px solid rgba(255, 110, 110, 0.6);
        color: rgba(255, 220, 220, 0.95);
      }

      .chat-message.loading .message-content {
        font-style: italic;
        color: rgba(255, 255, 255, 0.85);
      }

      .loading-indicator {
        display: inline-flex;
        gap: 6px;
        align-items: center;
      }

      .loading-indicator span {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.7);
        animation: loadingBounce 0.9s infinite ease-in-out;
      }

      .loading-indicator span:nth-child(2) {
        animation-delay: 0.15s;
      }

      .loading-indicator span:nth-child(3) {
        animation-delay: 0.3s;
      }

      .email-form {
        margin-top: 24px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .email-form.hidden {
        display: none;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .form-group label {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--frost);
      }

      .form-group input,
      .form-group textarea {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        padding: 12px 16px;
        color: var(--frost);
        font-family: inherit;
        font-size: 0.95rem;
        resize: vertical;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: rgba(255, 255, 255, 0.4);
        background: rgba(0, 0, 0, 0.4);
      }

      .form-group textarea {
        min-height: 120px;
        line-height: 1.6;
      }

      .send-button {
        background: var(--emerald);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 14px 28px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 180ms ease, transform 180ms ease;
        align-self: flex-start;
      }

      .send-button:hover:not(:disabled) {
        background: #167a5a;
        transform: translateY(-2px);
      }

      .send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .feedback-section {
        margin-top: 32px;
        padding-top: 32px;
        border-top: 2px solid rgba(255, 255, 255, 0.2);
        display: none;
      }

      .feedback-section.show {
        display: block;
        animation: fadeIn 0.5s ease-in;
      }

      .feedback-tips {
        list-style: none;
        padding: 0;
        margin: 20px 0;
      }

      .feedback-tips li {
        padding-left: 28px;
        margin-bottom: 16px;
        line-height: 1.7;
        color: var(--frost-muted);
        position: relative;
      }

      .feedback-tips li:before {
        content: "‚úì";
        position: absolute;
        left: 0;
        color: var(--emerald);
        font-weight: bold;
        font-size: 1.2rem;
      }

      .reset-button {
        background: rgba(255, 255, 255, 0.1);
        color: var(--frost);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        padding: 10px 20px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 180ms ease;
        margin-top: 16px;
      }

      .reset-button:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      @media (max-width: 720px) {
        .template .body {
          font-size: 0.85rem;
        }
        .message-content {
          margin-left: 0;
        }
        .chat-container {
          max-height: 400px;
        }
        .side-by-side-container {
          flex-direction: column;
        }
        .warning-section {
          flex: 1;
          position: static;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <a href="/" class="back-link">‚Üê Back to Home</a>
        <h1>How to Grovel (The Right Way)</h1>
        <p class="subtitle">A guide to cultivating great relationships with your teachers ‚Äî no actual groveling required.</p>
      </header>

      <section>
        <h2>Why It Matters</h2>
        <p>
          A strong relationship with your teachers makes your school life easier and more meaningful. It builds mutual respect, helps you learn better, and might even make those recommendation letters write themselves. The goal isn't flattery ‚Äî it's connection.
        </p>
      </section>

      <section>
        <h2>The Steps</h2>
        <ol class="step-list">
          <li>
            <strong>Step 1: Show Up</strong>
            <p>
              Spend time in your teacher's orbit. Drop by their office hours ‚Äî even when you don't need help. Ask questions about class topics, or just check in about how the week's going. Being a familiar, friendly face makes a huge difference.
            </p>
          </li>
          <li>
            <strong>Step 2: Find Common Ground</strong>
            <p>
              Teachers are people too! Ask about what they're reading, watching, or researching. Maybe you share an interest in a podcast, a favorite author, or a sports team. Genuine conversation (not "grade fishing") goes a long way.
            </p>
          </li>
          <li>
            <strong>Step 3: Communicate Early and Honestly</strong>
            <p>
              If you're struggling, running late, or need an extension, reach out before it becomes a crisis. Clear, respectful communication builds trust ‚Äî and prevents last-minute panicked emails.
            </p>
          </li>
          <li>
            <strong>Step 4: Express Gratitude</strong>
            <p>
              A simple "thank you" goes a long way. Whether it's for extra feedback, a recommendation letter, or just a good lecture ‚Äî let them know you appreciate their time and effort.
            </p>
          </li>
        </ol>
      </section>

      <section>
        <div class="template">
          <h3>The Grovel Template (for Emails That Actually Work)</h3>
          <div class="subject">Subject: Quick Follow-Up / Request for [Help / Feedback / Extension]</div>
          <div class="body">Body:

Good morning/afternoon/evening [Teacher's Name],

I hope you're doing well. I wanted to reach out about [specific class, assignment, or concern]. [Briefly explain your situation ‚Äî keep it honest, concise, and polite.]

I understand [acknowledge their perspective, e.g., "this is short notice" or "it's a busy time"], but I'd really appreciate any advice or flexibility you can offer.

Thank you so much for your time and for [something positive about their class or support].

Best,
[Your Name]
[Your Class/Section, if relevant]</div>
        </div>
      </section>

      <div class="side-by-side-container">
        <section class="warning-section">
          <div class="warning">
            <h3>‚ö†Ô∏è Important: If They Push Back</h3>
            <p>
              Sometimes a teacher might follow up and say something like: "If I make this exception for you, I'd have to make it for everyone."
            </p>
            <p>
              If this happens, respond with understanding and respect for their position:
            </p>
            <div class="response">
              "I totally understand ‚Äî that's completely fair. If anyone else were in my position, I think they'd appreciate the same understanding."
            </div>
          </div>
        </section>

        <section class="chat-section">
          <h2>Practice Your Email Skills</h2>
          <p>
            Try writing two emails to ask your teacher for something. The teacher will respond once (and might say no). After you send both emails, you'll get personalized tips on how to improve your approach.
          </p>
          
          <div class="chat-container" id="chatContainer">
            <p class="chat-placeholder" id="chatPlaceholder">Messages will appear here</p>
          </div>

          <form class="email-form" id="emailForm">
            <div class="form-group">
              <label for="emailSubject">Subject:</label>
              <input type="text" id="emailSubject" placeholder="e.g., Request for Extension on Essay" required>
            </div>
            <div class="form-group">
              <label for="emailBody">Email Body:</label>
              <textarea id="emailBody" placeholder="Write your email here..." required></textarea>
            </div>
            <button type="submit" class="send-button" id="sendButton">Send Email</button>
          </form>

          <div class="feedback-section" id="feedbackSection">
            <h3>üí° Tips to Improve Your Emails</h3>
            <ul class="feedback-tips" id="feedbackTips">
              <!-- Tips will be added here -->
            </ul>
            <button class="reset-button" id="resetButton">Try Again</button>
          </div>
        </section>
      </div>

      <section>
        <h2>Bonus Tips</h2>
        <ul class="bonus-tips">
          <li>Don't write emails in a rush ‚Äî reread before sending.</li>
          <li>Avoid dramatic apologies ("I'm the worst student ever!") ‚Äî stay sincere.</li>
          <li>When things go wrong, own it. Responsibility > excuses.</li>
          <li>Follow up in person when possible ‚Äî it shows accountability.</li>
        </ul>
      </section>
    </main>

    <script>
      let emailCount = 0;
      let isSending = false;
      const CHAT_ENDPOINT = '/chat';
      const chatContainer = document.getElementById('chatContainer');
      const chatPlaceholder = document.getElementById('chatPlaceholder');
      const emailForm = document.getElementById('emailForm');
      const emailSubject = document.getElementById('emailSubject');
      const emailBody = document.getElementById('emailBody');
      const sendButton = document.getElementById('sendButton');
      const feedbackSection = document.getElementById('feedbackSection');
      const feedbackTips = document.getElementById('feedbackTips');
      const resetButton = document.getElementById('resetButton');
      const assistantErrorText = 'I ran into an issue responding. Please try again in a moment.';

      function addMessage(sender, subject, body, isTeacher = false) {
        if (chatPlaceholder) {
          chatPlaceholder.style.display = 'none';
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message';
        
        const headerDiv = document.createElement('div');
        headerDiv.className = `message-header ${isTeacher ? 'teacher' : ''}`;
        
        const iconDiv = document.createElement('div');
        iconDiv.className = 'icon';
        iconDiv.textContent = isTeacher ? 'üë®‚Äçüè´' : '‚úâÔ∏è';
        
        const senderName = document.createElement('span');
        senderName.textContent = isTeacher ? 'Prof. [Name]' : 'You';
        
        headerDiv.appendChild(iconDiv);
        headerDiv.appendChild(senderName);
        
        const contentDiv = document.createElement('div');
        contentDiv.className = `message-content ${isTeacher ? 'teacher' : ''}`;
        
        const subjectLine = document.createElement('div');
        subjectLine.style.fontWeight = '600';
        subjectLine.style.marginBottom = '8px';
        subjectLine.style.color = isTeacher ? 'rgba(255, 240, 200, 1)' : 'var(--frost)';
        subjectLine.textContent = `Subject: ${subject}`;
        
        const bodyText = document.createElement('div');
        bodyText.textContent = body;
        
        contentDiv.appendChild(subjectLine);
        contentDiv.appendChild(bodyText);
        
        messageDiv.appendChild(headerDiv);
        messageDiv.appendChild(contentDiv);
        
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return messageDiv;
      }

      function showAssistantThinking(subject) {
        if (chatPlaceholder) {
          chatPlaceholder.style.display = 'none';
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message loading';

        const headerDiv = document.createElement('div');
        headerDiv.className = 'message-header teacher';

        const iconDiv = document.createElement('div');
        iconDiv.className = 'icon';
        iconDiv.textContent = 'üë®‚Äçüè´';

        const senderName = document.createElement('span');
        senderName.textContent = 'Prof. [Name]';

        headerDiv.appendChild(iconDiv);
        headerDiv.appendChild(senderName);

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content teacher';

        const subjectLine = document.createElement('div');
        subjectLine.style.fontWeight = '600';
        subjectLine.style.marginBottom = '8px';
        subjectLine.style.color = 'rgba(255, 240, 200, 1)';
        subjectLine.textContent = `Subject: ${subject}`;

        const bodyText = document.createElement('div');
        bodyText.innerHTML = '<div class="loading-indicator"><span></span><span></span><span></span></div>';

        contentDiv.appendChild(subjectLine);
        contentDiv.appendChild(bodyText);

        messageDiv.appendChild(headerDiv);
        messageDiv.appendChild(contentDiv);

        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        return { container: messageDiv, bodyElement: bodyText, contentElement: contentDiv };
      }

      function finalizeAssistantMessage(target, replyText) {
        target.container.classList.remove('loading');
        target.contentElement.classList.remove('error');
        target.bodyElement.textContent = replyText;
      }

      function handleAssistantError(target, fallbackMessage) {
        target.container.classList.remove('loading');
        target.contentElement.classList.add('error');
        target.bodyElement.textContent = fallbackMessage;
      }

      function setSendingState(sending) {
        isSending = sending;

        if (sending) {
          sendButton.disabled = true;
          sendButton.textContent = 'Sending...';
        } else {
          sendButton.disabled = false;
          sendButton.textContent = emailCount === 0 ? 'Send Email' : 'Send Follow-up';
        }
      }

      function prepareForFollowUpUI() {
        const label = emailForm.querySelector('label[for="emailBody"]');
        if (label) {
          label.textContent = 'Email Body (Follow-up):';
        }
        emailSubject.placeholder = 'e.g., Re: Request for Extension on Essay';
        emailBody.placeholder = 'Write your follow-up email here...';
      }

      async function sendMessageToBot(message) {
        try {
          const response = await fetch(CHAT_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
          });
          const data = await response.json();

          if (!response.ok) {
            throw new Error(data?.error || 'The assistant is unavailable right now.');
          }

          if (!data.reply) {
            throw new Error('The assistant returned an empty response.');
          }

          return data.reply;
        } catch (error) {
          console.error('Chat request failed:', error);
          throw error instanceof Error ? error : new Error('Failed to reach the assistant.');
        }
      }

      function generateFeedback(email1, email2) {
        const tips = [];
        
        // Check for common issues
        const email1Lower = email1.toLowerCase();
        const email2Lower = email2.toLowerCase();
        
        // Check for tone issues
        const sorryCount = (email1Lower.match(/sorry/g) || []).length;
        if (sorryCount > 2 || email1Lower.includes('i\'m so sorry') || 
            email1Lower.includes('terribly sorry')) {
          tips.push("Avoid over-apologizing. One sincere apology is enough ‚Äî excessive apologies can come across as insincere or manipulative.");
        }
        
        if (email1Lower.includes('i know this is') && email1Lower.includes('but')) {
          tips.push("Try framing your request more positively. Instead of leading with what you know is inconvenient, focus on what you're asking for and why.");
        }
        
        // Check for specificity
        if (email1.length < 100) {
          tips.push("Be more specific about your situation. Teachers appreciate context ‚Äî briefly explain what's happening and why you need help.");
        }
        
        // Check for acknowledgment
        if (!email2Lower.includes('understand') && !email2Lower.includes('fair') && !email2Lower.includes('appreciate')) {
          tips.push("In your follow-up, acknowledge the teacher's position. Show that you understand their constraints ‚Äî this builds respect and rapport.");
        }
        
        // Check for gratitude
        if (!email1Lower.includes('thank') && !email2Lower.includes('thank')) {
          tips.push("Always express gratitude. Thank the teacher for their time and consideration, even if they say no.");
        }
        
        // Check for professionalism
        if (email1Lower.includes('hey') || email1Lower.includes('hiya') || email1Lower.includes('yo')) {
          tips.push("Use a professional greeting. 'Good morning/afternoon/evening' or 'Hello' works better than casual greetings.");
        }
        
        // Check for urgency/demanding tone
        if (email1Lower.includes('need') && email1Lower.includes('need') && email1Lower.split('need').length > 3) {
          tips.push("Frame your request as asking for help rather than stating what you need. 'I was hoping you might consider...' sounds more respectful than 'I need...'");
        }
        
        // Check for excuses vs. responsibility
        if ((email1Lower.includes('not my fault') || email1Lower.includes('not fair')) && 
            !email1Lower.includes('i understand')) {
          tips.push("Take responsibility for your situation. Even if external factors are involved, acknowledge your role and show you're working to improve.");
        }
        
        // Generic helpful tips if no specific issues found
        if (tips.length === 0) {
          tips.push("Your emails show good communication! Remember to always acknowledge the teacher's perspective when they explain their constraints.");
          tips.push("Consider reaching out earlier next time. The earlier you communicate, the more flexibility teachers can offer.");
          tips.push("After a rejection, a respectful follow-up that shows understanding (like acknowledging fairness) can help maintain a positive relationship.");
        }
        
        // Always add these key tips
        if (!tips.some(t => t.includes('follow-up'))) {
          tips.push("In your second email, focus on understanding their position. Phrases like 'I totally understand ‚Äî that's completely fair' show maturity and respect.");
        }
        
        if (!tips.some(t => t.includes('early'))) {
          tips.push("Pro tip: Next time, try reaching out as soon as you know you might need help. Early communication builds trust.");
        }
        
        return tips;
      }

      function updateFeedbackTips(shouldScroll = false) {
        const userMessages = Array.from(chatContainer.querySelectorAll('.message-content:not(.teacher)'));

        if (userMessages.length < 2) {
          return;
        }

        const [firstBodyElement, secondBodyElement] = userMessages.slice(-2);
        const firstBody = firstBodyElement?.querySelectorAll('div')[1]?.textContent.trim() || '';
        const secondBody = secondBodyElement?.querySelectorAll('div')[1]?.textContent.trim() || '';

        const tips = generateFeedback(firstBody, secondBody);

        feedbackTips.innerHTML = '';
        tips.forEach(tip => {
          const li = document.createElement('li');
          li.textContent = tip;
          feedbackTips.appendChild(li);
        });

        const wasHidden = !feedbackSection.classList.contains('show');
        feedbackSection.classList.add('show');

        if (shouldScroll || wasHidden) {
          feedbackSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      }

      emailForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (isSending) {
          return;
        }
        
        const subject = emailSubject.value.trim();
        const body = emailBody.value.trim();
        
        if (!subject || !body) {
          return;
        }
        
        addMessage('You', subject, body);
        emailCount++;
        
        const messagePayload = [
          `Subject: ${subject}`,
          '',
          body,
          '',
          'Please respond as the teacher with empathy while maintaining clear boundaries.'
        ].join('\n');

        emailSubject.value = '';
        emailBody.value = '';
        
        if (emailCount === 1) {
          prepareForFollowUpUI();
        }

        setSendingState(true);
        const assistantSubject = subject.toLowerCase().startsWith('re:') ? subject : `Re: ${subject}`;
        const assistantPlaceholder = showAssistantThinking(assistantSubject);

        try {
          const reply = await sendMessageToBot(messagePayload);
          finalizeAssistantMessage(assistantPlaceholder, reply);
        } catch (error) {
          console.error('Failed to fetch assistant reply:', error);
          handleAssistantError(assistantPlaceholder, assistantErrorText);
        } finally {
          setSendingState(false);
        }

        if (emailCount >= 2) {
          const shouldScroll = !feedbackSection.classList.contains('show');
          setTimeout(() => updateFeedbackTips(shouldScroll), 1000);
        }
      });

      resetButton.addEventListener('click', () => {
        emailCount = 0;
        isSending = false;
        chatContainer.innerHTML = '';
        if (chatPlaceholder) {
          chatPlaceholder.style.display = 'block';
          chatContainer.appendChild(chatPlaceholder);
        }
        emailSubject.value = '';
        emailBody.value = '';
        emailSubject.placeholder = 'e.g., Request for Extension on Essay';
        emailBody.placeholder = 'Write your email here...';
        const label = emailForm.querySelector('label[for="emailBody"]');
        if (label) {
        label.textContent = 'Email Body:';
        }
        emailForm.classList.remove('hidden');
        feedbackSection.classList.remove('show');
        feedbackTips.innerHTML = '';
        setSendingState(false);
      });

      setSendingState(false);
    </script>
  </body>
</html>

